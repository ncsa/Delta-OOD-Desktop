# Batch Connect app configuration file
#

<%-
  require 'open3'

  def get_available_accounts()
    cmd = "sacctmgr -nP show assoc format=account where user=#{CurrentUser.name}"
    stdout, stderr, status = Open3.capture3(cmd)
    accounts = stdout.split("\n")
    accounts.delete("noalloc")
    accounts
  end
%>

---
cluster: 
  - 'delta'

# Define attribute values that aren't meant to be modified by the user within
# the Dashboard form
attributes:

# specify widgets for user modifiable job settings
  bc_account:
    label: "Name of account"
    widget: "select"
    required: true
    help: "Account selected must match job type (CPU or GPU)."
    options:
      <%- get_available_accounts().each do |account| %>
      - ["<%= account %>", "<%= account %>"]
      <%- end %>
  
  bc_reservation:
    label: "Name of reservation (leave empty if none)"
    widget: "text_field"
    value: ""
    help: "RHEL 9 sessions will be submitted to the RH9 reservation by default. Entering another reservation here will override the default behavior."

  bc_image:
    label: "Container image to use"
    widget: "select"
    options:
      # - ["desktop-base","/sw/oodimages/desktop-base.sif"]
      - ["RHEL 8 w/ CUDA 12.4","/sw/oodimages/desktop-cuda124-py39.sif"]
      - ["RHEL 9 w/ CUDA 12.8","/sw/oodimages/desktop-rhel9.sif"]

  bc_partition:
    label: "Partition"
    widget: "select"
    value: "cpu-interactive"
    help: "Interactive partitions are limited to one hour."
    options:
      - ["cpu-interactive","cpu-interactive"]
      - ["gpuH200x8-interactive","gpuH200x8-interactive"]
      - ["gpuA100x4-interactive","gpuA100x4-interactive"]
      - ["gpuA40x4-interactive","gpuA40x4-interactive"]
      - ["cpu","cpu"]
      - ["gpuH200x8","gpuH200x8"]
      - ["gpuA100x4","gpuA100x4"]
      - ["gpuA40x4","gpuA40x4"]

  bc_num_cores:
    label: "Number of CPUs"
    widget: "number_field"
    required: true
    min: "1"

  bc_num_memory:
    label: "Amount of RAM"
    widget: "text_field"
    pattern: "[0-9]+[MG]{1}"
    help: "Use Slurm format, e.g. 4096M, 10G. If left blank, 1000 MB will be allocated per CPU core requested. A minimum of 2GB is required for each job and lower values will be substituted before submission."

  bc_num_gpus:
    label: "Number of GPUs"
    widget: "number_field"
#    max: "4"
    min: "0"

  bc_duration:
    label: "Duration of job"
    widget: "text_field"
    required: true
    value: "1:00:00"
    help: "Slurm format: DD-HH:MM:SS"

  bc_vnc_resolution:
    required: true

# All of the attributes that make up the Dashboard form (in respective order),
# and made available to the submit configuration file and the template ERB
# files
#
form:
  - cluster
  - bc_image
  - bc_account
  - bc_partition
  - bc_duration
  - bc_reservation
  - bc_num_cores
  - bc_num_memory
  - bc_num_gpus
  - bc_vnc_resolution
  - bc_email_on_started
